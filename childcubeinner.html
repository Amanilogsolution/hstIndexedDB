<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="css/all.css" />
    <link rel="stylesheet" href="css/boostrap.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="manifest" href="manifest.json" />
    <title>:: CRAWL ::</title>
  </head>

  <body id="home" data-spy="scroll" data-target="#main-nav">
    <!-- START HERE -->
    <nav
      class="navbar navbar-expand-md navbar-light fixed-top py-2"
      id="main-nav"
    >
      <div class="container">
        <a href="index.html" class="navbar-brand navbar-brand">
          <img src="img/logo.png" height="60" alt="logo" />
        </a>
        <button
          class="navbar-toggler"
          data-toggle="collapse"
          data-target="#navbarCollapse"
        >
          &#9776;
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a href="index.html" class="nav-link">
                <img
                  class="fa"
                  src="./img/house.svg"
                  height="18"
                  width="18"
                  alt="Home"
                />
                Home</a
              >
            </li>
            <li class="nav-item">
              <a href="childcube.html" class="nav-link">
                <img
                  class="fa"
                  src="./img/childCube.png"
                  height="20"
                  width="20"
                  alt="Child Cube"
                />
                check stock</a
              >
            </li>

            <li class="nav-item">
              <a href="inventory.html" class="nav-link">
                <img
                  class="fa"
                  src="./img/barcode-scanner.png"
                  height="18"
                  width="18"
                  alt="RFID Scanner"
                />
                identify item</a
              >
            </li>

            <li class="nav-item">
              <a href="motherCube.html" class="nav-link">
                <img
                  class="fa"
                  src="./img/inventry_icon.svg"
                  height="20"
                  width="20"
                  alt="Inventory"
                />
                know your stock</a
              >
            </li>

            <li class="nav-item">
              <a href="#"  onclick="downloadCSV()" style="cursor: pointer;" class="nav-link">
                <img class="fa" src="./img/barcode-scanner.png" height="18" width="18" alt="RFID Scanner" />
                Download</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Boxes-->
    <div style="background-color: #f8f9fa" class="ml-3 font-italic">
      <h6 class="mt-4">
        <a href="index.html"><small>Home</small></a> >
        <small>Identification</small>
      </h6>
    </div>
    <section id="boxes" class="px-2">
      <div class="container my-auto">
        <div class="row">
          <div class="card border-0">
            <img
              class="card-img-top"
              src="img/childcubehome.png" style="height: 350px;"
              alt="Card image cap"
            />
            <div class="card-body1 d-flex justify-content-center">
              <a href="childcube.html" class="btn btn-primary btn-lg"
                >scan child cube</a
              >
            </div>
          </div>
          <!-- <div class="col-md-12 py-1">
            <div class="card text-center bg-primary mb-resp">
              <div
                class="card-body shadow3-gray border border-danger"
                style="
                  background-image: url('img/childcubehome.png');
                  background-repeat: no-repeat;
                  background-size: cover;
                  background-size: auto;
                "
              ></div>
            </div>
          </div> -->
          <!-- <div class="col-md-6 py-1 mb-2">
            <a href="childcube.html" class="text-decoration-none">
              <div class="card text-center bg-primary mb-resp">
                <div class="card-body shadow3-gray">
                  <img
                    src="../img/childCube.png"
                    width="60"
                    height="60"
                    alt=""
                  />
                  <h3 class="card-title text-white mt-2">Child Cube</h3>
                </div>
              </div>
            </a>
          </div> -->
        </div>
      </div>
    </section>
    <!-- Footer -->
    <footer
      class="bg-light text-center text-dark card-footer shadow-top"
      id="footer-main"
    >
      <div class="container">
        <section>
          <a
            class="btn btn-outline-dark btn-floating m-1 float-left"
            href="index.html"
            role="button"
          >
            <img
              class="fa"
              src="./img/house.svg"
              height="20"
              width="20"
              alt="Home"
            />
          </a>

          <a class="btn btn-floating m-1 text-center" role="button">BHISHM </a>
          <!-- <a class="btn btn-outline-dark btn-floating m-1" href="inventory.html" role="button">
          <img class="fa" src="./img/barcode-scanner.png" height="20" width="20" alt="RFID Scanner" />
        </a>
        <a class="btn btn-outline-dark btn-floating " href="childcube.html" role="button">
          <img class="fa" src="./img/childCube.png" height="25" width="25" alt="Child Cube" />
        </a> -->
          <a
            class="btn btn-outline-dark btn-floating m-1 float-right"
            href="/"
            role="button"
          >
            Back
          </a>
        </section>
      </div>
    </footer>

    <script src="js/jquery-3.3.1.min.js"></script>

    <script src="js/bootstrap.min.js"></script>
    <script>
      // Download code
function removeDuplicatespack(data) {    
  let filteredpackdata=[]
  const stockData = getUniqueListBypackcode(data, "CC_EPCNO");
  stockData.map((ele)=>{
      const dataval =  data.filter(({CC_EPCNO}) => 
      [CC_EPCNO].some((val)=> val.includes(ele.CC_EPCNO))
      )
      const stockData = getUniqueListBypackcode(dataval, "PACK_CODE");
      uniqueArr = removeDuplicates(dataval);
      for(i=0;i<stockData.length;i++){
        var count = 0;
        var balance = 0;

        uniqueArr.filter((data)=>{
          if (data.PACK_NAME === stockData[i]["PACK_NAME"]) {
            count = count + 1;
            data.Status == "N" ? (balance = balance + 1) : null;
          } else {
            null;
          }
          stockData[i]["Count"] = count;
          stockData[i]["PACK_QTY"] = balance;

        })

      }

   setTimeout(()=>{


    console.log('Stock',stockData)
    for(i=0;i<stockData.length;i++){
      console.log(stockData[i].PACK_QTY)


      filteredpackdata.push({
        "MC_NO":stockData[i]['MC_NO'],
          "CC_NO":stockData[i]['CC_NO'],
          "PACK_CODE":stockData[i]['PACK_CODE'],
          "PACK_NAME":stockData[i]['PACK_NAME'],
          "PACK_BATCHNO":stockData[i]['PACK_BATCHNO'],
          "PACK_EXPIRY":stockData[i]['PACK_EXPIRY'],
        "PACK_QTY":stockData[i].PACK_QTY    
       })
    }

   },1000)


})


setTimeout(()=>{
  var data, filename, link;
  var csv = 'data:text/json;charset=utf-8,' + JSON.stringify(filteredpackdata);
        filename = 'jsonDataForTab.json';
        data = encodeURI(csv);
        link = document.createElement('a');
        link.setAttribute('href', data);
        link.setAttribute('download', filename);
        link.click();

 },2000) 



}

function getUniqueListBypackcode(arr, key) {
  return [...new Map(arr.map((item) => [item[key], item])).values()];
}

const idb = window.indexedDB;
function downloadCSV(args) {
 
const ldb = idb.open("CRM", 2);
ldb.onsuccess = function () {
const db = ldb.result;
const txn = db.transaction("tbl_rfid", "readonly");
const store = txn.objectStore("tbl_rfid");
const index = store.index("PACK_EPC");
let query = index.getAll();
query.onsuccess = (event) => {
  if (!event.target.result) {
    console.log(`this ${value} not match`);
  } else {
    console.log(event.target.result);
    removeDuplicatespack(event.target.result);

  }
};
};


}



function removeDuplicates(arr) {
  (seen = Object.create(null)),
    (result = arr.filter((o) => {
      var key = ["PACK_NAME", "PACK_EPC"].map((k) => o[k]).join("|");
      if (!seen[key]) {
        seen[key] = true;
        return true;
      }
    }));
  return result;
}
    </script>
  </body>
</html>